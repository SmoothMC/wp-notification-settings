name: Generate Changelog and Release

on:
  push:
    tags:
      - "*"

jobs:
  changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install git-cliff
        run: |
          LATEST=$(curl -s https://api.github.com/repos/orhun/git-cliff/releases/latest | jq -r '.tag_name')
          ASSET_URL=$(curl -s https://api.github.com/repos/orhun/git-cliff/releases/latest \
            | jq -r '.assets[] | select(.name | test("x86_64-unknown-linux-gnu.*\\.tar\\.gz$")) | .browser_download_url')

          echo "Downloading: $ASSET_URL"

          wget "$ASSET_URL" -O cliff.tar.gz
          mkdir cliff
          tar -xzf cliff.tar.gz -C cliff --strip-components=1

          sudo mv cliff/git-cliff /usr/local/bin/git-cliff
          git-cliff --version

      - name: Generate Changelog
        id: changelog
        run: |
          git cliff --tag "${{ steps.version.outputs.VERSION }}" > CHANGELOG.tmp
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.tmp >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Inject changelog into update.json
        run: |
          CHANGELOG=$(echo "${{ steps.changelog.outputs.changelog }}" | sed 's/"/\\"/g')
          jq --arg CHANGELOG "$CHANGELOG" '.changelog = $CHANGELOG' update.json > update.tmp && mv update.tmp update.json

      - name: Update last_updated field in update.json
        run: |
          DATE=$(date +%Y-%m-%d)
          sed -i "s/\"last_updated\": \".*\"/\"last_updated\": \"$DATE\"/" update.json

      - name: Update Stable Tag in readme.txt
        run: |
          sed -i "s/^Stable tag: .*/Stable tag: ${{ steps.version.outputs.VERSION }}/" wp-notification-settings/readme.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: "Release ${{ steps.version.outputs.VERSION }}"
          body: ${{ steps.changelog.outputs.changelog }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
